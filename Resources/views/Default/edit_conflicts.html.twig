{% extends '@ManuelTranslation/base.html.twig' %}

{% trans_default_domain "ManuelTranslationBundle" %}

{% block page_header %}{{ 'label.resolve_conflicts'|trans }}{% endblock %}

{% block page_header_rigth %}

{% endblock %}

{#{% set pagination_content %}#}
{#<div class="text-right">#}
    {#{{ knp_pagination_render(translations, 'KnpPaginatorBundle:Pagination:twitter_bootstrap_v3_pagination.html.twig') }}#}
{#</div>#}
{#{% endset %}#}

{% block content %}

    {#{{ dump(server_translations) }}#}

    <table class="table table-bordered table-striped table-hover translation-list">
        <thead>
            <tr>
                <th class="col-sm-3">{{ 'label.code'|trans }}</th>
                <th class="col-sm-9">{{ 'label.translation_values'|trans }}</th>
            </tr>
        </thead>
        <tbody>
            {% for item in translations %}
                {% set server_item = server_translations[item.domain][item.code]|default({}) %}
                <tr class="conflict-item">
                    <td>
                        <div {%- if not item.active %}class="text-muted"{% endif %}><strong class="code-text">{{ item.code }}</strong></div>
                        <div>
                            <small class="text-{{ item.active ? (item.conflicts ? 'danger' : item.isChanged ? 'success' : 'muted') : 'muted' }}">{{ item.domain }}</small>
                        </div>
                    </td>
                    <td>
                        <table class="table table-condensed table-bordered">
                            <tr>
                                <th colspan="5">
                                    {{ 'label.local_values'|trans }}
                                    <a class="resolve-conflicts pull-right btn btn-primary btn-xs" href="{{ path('manuel_translation_resolve_conflict', {id: item.id, use: 'local'}) }}"><span aria-hidden="true" class="glyphicon glyphicon-ok"></span></a>
                                </th>
                                <th colspan="5">
                                    {{ 'label.server_values'|trans }}
                                    <a class="resolve-conflicts pull-right btn btn-primary btn-xs" href="{{ path('manuel_translation_resolve_conflict', {id: item.id, use: 'server'}) }}"><span aria-hidden="true" class="glyphicon glyphicon-ok"></span></a>
                                </th>
                            </tr>
                            <tr>
                                <td colspan="5">
                                    {% for locale, value in item.values %}
                                        <pre>{{ value.value }}</pre>
                                    {% endfor %}
                                </td>
                                <td colspan="5">
                                    {% for locale, value in server_item.values %}
                                        <pre class="value-content data-{{ locale }}">{{ value.value }}</pre>
                                    {% endfor %}
                                </td>
                            </tr>
                            <tr>
                                <th>{{ 'label.active'|trans }}</th>
                                <th>{{ 'label.version'|trans }}</th>
                                <th>{{ 'label.server_changes'|trans }}</th>
                                <th>{{ 'label.autogenerated'|trans }}</th>
                                <th>{{ 'label.with_changes'|trans }}</th>

                                <th>{{ 'label.active'|trans }}</th>
                                <th>{{ 'label.version'|trans }}</th>
                                <th>{{ 'label.server_changes'|trans }}</th>
                                <th>{{ 'label.autogenerated'|trans }}</th>
                                <th>{{ 'label.with_changes'|trans }}</th>
                            </tr>
                            <tr class="text-center">
                                <td>{{ (item.active ? 'label.yes' : 'label.no')|trans }}</td>
                                <td>{{ item.version|number_format(0) }}</td>
                                <td>{{ item.serverEditions|number_format(0) }}</td>
                                <td>{{ (item.autogenerated ? 'label.yes' : 'label.no')|trans }}</td>
                                <td>{{ (item.isChanged ? 'label.yes' : 'label.no')|trans }}</td>

                                <td>{{ (server_item.active ? 'label.yes' : 'label.no')|trans }}</td>
                                <td>{{ server_item.version|number_format(0) }}</td>
                                <td>{{ server_item.serverEditions|number_format(0) }}</td>
                                <td>{{ (server_item.autogenerated ? 'label.yes' : 'label.no')|trans }}</td>
                                <td>{{ (server_item.isChanged ? 'label.yes' : 'label.no')|trans }}</td>
                            </tr>
                            <tr>
                                <td colspan="5">
                                    <div class="trans-files">
                                        <h6>{{ 'label.used_in'|trans }}</h6>
                                        <ul>
                                            {% for file in item.files %}
                                                <li>
                                                    <small>{{ file }}</small>
                                                </li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                </td>
                                <td colspan="5">
                                    <div class="trans-files">
                                        <h6>{{ 'label.used_in'|trans }}</h6>
                                        <ul>
                                            {% for file in server_item.files %}
                                                <li>
                                                    <small>{{ file }}</small>
                                                </li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                </td>
                            </tr>
                        </table>
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>

{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        $(".resolve-conflicts").on('click', function(e){
            var $btn = $(this);
            var $btns = $btn.closest('tr').find('.resolve-conflicts').button('loading');
            e.preventDefault();
            $.post($btn.attr('href'), function(res){
                $btns.button('reset');
                $btn.closest('.conflict-item').remove();

                if($('.conflict-item').size() == 0){
                    document.location = '{{ path('manuel_translation_list') }}';
                }
            })
        });
    </script>
{% endblock %}
