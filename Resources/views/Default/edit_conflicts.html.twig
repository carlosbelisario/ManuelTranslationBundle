{% extends '@ManuelTranslation/base.html.twig' %}

{% trans_default_domain "ManuelTranslationBundle" %}

{% block stylesheets %}
    {{ parent() }}
    <style>
        pre { white-space: pre-wrap; }
    </style>
{% endblock %}

{% block page_header %}{{ 'label.translation_list'|trans }}{% endblock %}

{% block page_header_rigth %}

{% endblock %}

{#{% set pagination_content %}#}
{#<div class="text-right">#}
    {#{{ knp_pagination_render(translations, 'KnpPaginatorBundle:Pagination:twitter_bootstrap_v3_pagination.html.twig') }}#}
{#</div>#}
{#{% endset %}#}

{% block content %}

    {#{{ dump(server_translations) }}#}

    <table class="table table-bordered table-striped table-hover translation-list">
        <thead>
            <tr>
                {#<th class="col-sm-1"></th>#}
                <th class="col-sm-3">{{ 'label.code'|trans }}</th>
                <th class="col-sm-9">{{ 'label.translation_values'|trans }}</th>
                {#{% for locale in locales %}#}
                {#<th>{{ locale }}</th>#}
                {#{% endfor %}#}
                {#<th class="col-sm-1">{{ 'label.actions'|trans }}</th>#}
            </tr>
        </thead>
        <tbody>
            {% for item in translations %}
                {% set server_item = server_translations[item.domain][item.code]|default({}) %}
                <tr class="conflict-item">
                    <td>
                        <div {%- if not item.active %}class="text-muted"{% endif %}><strong class="code-text">{{ item.code }}</strong></div>
                        <div>
                            <small class="text-{{ item.active ? (item.conflicts ? 'danger' : item.localEditions ? 'success' : 'muted') : 'muted' }}">{{ item.domain }}</small>
                        </div>
                    </td>
                    <td>
                        <table class="table table-condensed table-bordered">
                            <tr>
                                <th colspan="4">
                                    Local Values
                                    <a class="resolve-conflicts pull-right btn btn-primary btn-xs" href="{{ path('manuel_translation_resolve_conflict', {id: item.id, use: 'local'}) }}"><span aria-hidden="true" class="glyphicon glyphicon-ok"></span></a>
                                </th>
                                <th colspan="4">
                                    Server Values
                                    <a class="resolve-conflicts pull-right btn btn-primary btn-xs" href="{{ path('manuel_translation_resolve_conflict', {id: item.id, use: 'server'}) }}"><span aria-hidden="true" class="glyphicon glyphicon-ok"></span></a>
                                </th>
                            </tr>
                            <tr>
                                <td colspan="4">
                                    {% for locale, value in item.values %}
                                        <pre>{{ value.value }}</pre>
                                    {% endfor %}
                                </td>
                                <td colspan="4">
                                    {% for locale, value in server_item.values %}
                                        <pre class="value-content data-{{ locale }}">{{ value.value }}</pre>
                                    {% endfor %}
                                </td>
                            </tr>
                            <tr>
                                <th>Active</th>
                                <th>Version</th>
                                <th>Autogenerated</th>
                                <th>With Changes</th>
                                <th>Status</th>
                                <th>Version</th>
                                <th>Autogenerated</th>
                                <th>With Changes</th>
                            </tr>
                            <tr class="text-center">
                                <td>{{ item.active ? 'Yes' : 'No' }}</td>
                                <td>{{ item.synchronizations|number_format(0) }}</td>
                                <td>{{ item.autogenerated ? 'Yes' : 'No' }}</td>
                                <td>{{ item.localEditions > 0 ? 'Yes' : 'No' }}</td>

                                <td>{{ server_item.active ? 'Active' : 'Inactive' }}</td>
                                <td>{{ server_item.synchronizations|number_format(0) }}</td>
                                <td>{{ server_item.autogenerated ? 'Yes' : 'No' }}</td>
                                <td>{{ server_item.localEditions > 0 ? 'Yes' : 'No' }}</td>
                            </tr>
                        </table>
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>

{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        $(".resolve-conflicts").on('click', function(e){
            var $btn = $(this);
            var $btns = $btn.closest('tr').find('.resolve-conflicts').button('loading');
            e.preventDefault();
            $.post($btn.attr('href'), function(res){
                $btns.button('reset');
                $btn.closest('.conflict-item').remove();

                if($('.conflict-item').size() == 0){
                    document.location = '{{ path('manuel_translation_list') }}';
                }
            })
        });
    </script>
{% endblock %}
